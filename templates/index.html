<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý Sản Phẩm AI</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --sidebar-bg: #0f172a;
            --sidebar-text: #94a3b8;
            --active-item: #1e293b;
            --accent: #10b981;
            --bg-body: #f1f5f9;
            --card-bg: #ffffff;
            --text-dark: #1e293b;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg-body); color: var(--text-dark); height: 100vh; display: flex; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px; background: var(--sidebar-bg); color: var(--sidebar-text);
            display: flex; flex-direction: column; padding: 20px;
            box-shadow: 4px 0 10px rgba(0,0,0,0.05); z-index: 100; flex-shrink: 0;
        }
        
        .brand {
            font-size: 20px; font-weight: 700; color: white; text-align: center;
            margin-bottom: 40px; text-transform: uppercase; letter-spacing: 1px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .brand i { color: var(--accent); font-size: 28px; }

        .menu-item {
            padding: 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer;
            transition: 0.3s; display: flex; align-items: center; gap: 15px; font-weight: 500;
        }
        .menu-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .menu-item.active { background: var(--active-item); color: var(--accent); border-left: 4px solid var(--accent); }
        .menu-item i { width: 20px; text-align: center; }

        .user-info {
            margin-top: auto; padding: 15px; background: rgba(255,255,255,0.05);
            border-radius: 8px; display: flex; align-items: center; gap: 10px;
        }
        .avatar { width: 35px; height: 35px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;}

        /* --- MAIN CONTENT AREA --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; }

        /* HEADER TRANG */
        .page-header { margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-size: 24px; font-weight: 700; color: var(--text-dark); }
        .breadcrumb { font-size: 14px; color: #64748b; margin-top: 5px; }

        /* --- CÁC SECTION (TRANG CON) --- */
        .section-view { display: none; animation: fadeIn 0.3s ease-in-out; }
        .section-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- DASHBOARD STYLES --- */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .kpi-card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 4px solid transparent; }
        .kpi-card.blue { border-color: #3b82f6; }
        .kpi-card.green { border-color: #10b981; }
        .kpi-card.red { border-color: #ef4444; }
        .kpi-card.purple { border-color: #8b5cf6; }
        .kpi-label { font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; }
        .kpi-value { font-size: 28px; font-weight: 700; margin-top: 5px; color: var(--text-dark); }
        
        .monitor-area { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; height: 550px; }
        .panel { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); display: flex; flex-direction: column; }
        .panel-header { font-size: 16px; font-weight: 600; margin-bottom: 15px; color: var(--text-dark); border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; }

        .camera-container { flex: 1; background: #000; border-radius: 8px; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; min-height: 0; }
        #live-image { width: 100%; height: 100%; object-fit: contain; }
        #result-badge { position: absolute; top: 15px; right: 15px; padding: 8px 16px; border-radius: 6px; font-weight: 700; color: white; font-size: 14px; background: rgba(0,0,0,0.6); z-index: 10; }

        /* --- TABLE STYLES --- */
        .table-container { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; padding: 12px; background: #f8fafc; color: #64748b; font-size: 13px; font-weight: 600; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        td { padding: 12px; border-bottom: 1px solid #e2e8f0; font-size: 14px; color: #334155; vertical-align: middle; }
        tr:hover { background: #f1f5f9; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .status-ok { background: #dcfce7; color: #166534; }
        .status-ng { background: #fee2e2; color: #991b1b; }
        
        /* Buttons */
        .btn-primary { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; text-decoration: none; font-size: 14px; }
        .btn-primary:hover { background: #059669; }
        .control-panel { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .btn-mode { flex: 1; padding: 10px; border: 1px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; color: #64748b; font-weight: 500; min-width: 80px; }
        .btn-mode.active { background: #eff6ff; border-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .monitor-area { grid-template-columns: 1fr; height: auto; }
            .camera-container { height: 400px; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand"><i class="fa-solid fa-industry"></i> SMART FACTORY</div>
    
    <div class="menu-item active" onclick="switchTab(this, 'dashboard')">
        <i class="fa-solid fa-chart-pie"></i> Trang chủ
    </div>
    <div class="menu-item" onclick="switchTab(this, 'history')">
        <i class="fa-solid fa-clock-rotate-left"></i> Lịch sử vận hành
    </div>
    <div class="menu-item" onclick="switchTab(this, 'logs')">
        <i class="fa-solid fa-book"></i> Nhật ký hoạt động
    </div>
    
    <div class="user-info">
        <div class="avatar">{{ user[0] | upper if user else 'U' }}</div>
        <div>
            <div style="font-size: 14px; font-weight: 600; color: white;">{{ user if user else 'Admin' }}</div>
            <div style="font-size: 12px; color: #64748b; cursor: pointer;" onclick="window.location.href='/logout'">Đăng xuất</div>
        </div>
    </div>
</div>

<div class="main-content">
    
    <div id="section-dashboard" class="section-view active">
        <div class="page-header">
            <div>
                <div class="page-title">Tổng quan hệ thống</div>
                <div class="breadcrumb">Trang chủ / Giám sát thời gian thực</div>
            </div>
            <div>
                <input type="file" id="ai-file-input" style="display: none;" accept="image/*" onchange="uploadAndTestAI()">
                <button class="btn-primary" onclick="document.getElementById('ai-file-input').click()">
                    <i class="fa-solid fa-upload"></i> Test Ảnh
                </button>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card blue">
                <div class="kpi-label">Tổng sản phẩm</div>
                <div class="kpi-value" id="stat-total">0</div>
            </div>
            <div class="kpi-card green">
                <div class="kpi-label">Sản phẩm Đạt (OK)</div>
                <div class="kpi-value" id="stat-ok">0</div>
            </div>
            <div class="kpi-card red">
                <div class="kpi-label">Sản phẩm Lỗi (NG)</div>
                <div class="kpi-value" id="stat-ng">0</div>
            </div>
            <div class="kpi-card purple">
                <div class="kpi-label">Độ tin cậy AI</div>
                <div class="kpi-value" id="stat-ai">---</div>
            </div>
        </div>

        <div class="monitor-area">
            <div class="panel">
                <div class="panel-header">Camera Giám Sát</div>
                <div class="camera-container">
                    <div id="result-badge" style="display:none;">WAITING</div>
                    <img id="live-image" src="/static/uploads/live.jpg" alt="Camera Feed" onerror="this.onerror=null; this.src='https://placehold.co/800x600?text=No+Signal';">
                </div>
                <div class="control-panel">
                    <button id="btn-mode-1" class="btn-mode active" onclick="changeMode(1)">Tự động</button>
                    <button id="btn-mode-2" class="btn-mode" onclick="changeMode(2)">Stream</button>
                    <button id="btn-mode-3" class="btn-mode" onclick="changeMode(3)">Thủ công</button>
                    <button id="btn-capture" class="btn-primary" style="flex:2; display:none;" onclick="manualCapture()">
                        <i class="fa-solid fa-camera"></i> Chụp Ngay
                    </button>
                </div>
                
                <div id="hardware-controls" style="display: none; width: 100%; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
                    <div style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 5px;">TEST PHẦN CỨNG</div>
                    <div style="display: flex; gap: 10px;">
                        <button id="btn-conveyor" class="btn-mode" onclick="toggleConveyor()">
                            <i class="fa-solid fa-tape"></i> Băng tải: <span id="lbl-conveyor">OFF</span>
                        </button>
                        <button class="btn-mode" onclick="triggerValve()">
                            <i class="fa-solid fa-wind"></i> Kích Van Khí
                        </button>
                    </div>
                </div>

            </div>
            <div class="panel">
                <div class="panel-header">Tỉ lệ chất lượng</div>
                <div style="flex:1; position: relative; min-height: 200px;">
                    <canvas id="qualityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="section-history" class="section-view">
        <div class="page-header">
            <div>
                <div class="page-title">Lịch sử vận hành</div>
                <div class="breadcrumb">Dữ liệu / Chi tiết sản phẩm</div>
            </div>
            <button class="btn-primary" onclick="window.location.href='/export_excel'">
                <i class="fa-solid fa-file-excel"></i> Xuất Báo Cáo
            </button>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Hình ảnh</th>
                        <th>Ngày</th>
                        <th>Giờ</th>
                        <th>Kết quả</th>
                        <th>Trạng thái</th>
                    </tr>
                </thead>
                <tbody id="history-table-body">
                    <tr><td colspan="5" style="text-align:center;">Đang tải dữ liệu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="section-logs" class="section-view">
        <div class="page-header">
            <div>
                <div class="page-title">Nhật ký hệ thống</div>
                <div class="breadcrumb">Hệ thống / Ghi nhận hoạt động</div>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Thời gian</th>
                        <th>Người dùng</th>
                        <th>Hành động</th>
                        <th>Chi tiết</th>
                    </tr>
                </thead>
                <tbody id="logs-table-body">
                    <tr><td colspan="4" style="text-align:center;">Đang tải dữ liệu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    // --- CẤU HÌNH BIỂU ĐỒ ---
    Chart.register(ChartDataLabels);
    let ctx = document.getElementById('qualityChart').getContext('2d');
    let chart = new Chart(ctx, {
        type: 'doughnut',
        data: { 
            labels: ['OK', 'NG'], 
            datasets: [{ 
                data: [0, 0], 
                backgroundColor: ['#10b981', '#ef4444'], 
                borderWidth: 0,
                hoverOffset: 4
            }] 
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            cutout: '75%', 
            plugins: { 
                legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } }, 
                datalabels: { 
                    color: '#fff', 
                    font: { weight: 'bold', size: 14 },
                    formatter: (value, ctx) => {
                        if(value === 0) return "";
                        let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                        let percentage = (value*100 / sum).toFixed(1) + "%";
                        return percentage;
                    }
                } 
            } 
        }
    });

    let currentMode = 1;
    let isProcessing = false;
    let conveyorState = false;
    
    // --- BIẾN QUAN TRỌNG ĐỂ SỬA LỖI KHÔNG CẬP NHẬT ẢNH ---
    let lastDisplayedTime = 0; 

    // --- HÀM CHUYỂN TAB (SPA Logic) ---
    function switchTab(element, tabName) {
        document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
        document.getElementById('section-' + tabName).classList.add('active');

        if(tabName === 'history') loadHistoryData();
        if(tabName === 'logs') loadLogsData();
    }

    // --- HÀM LOAD DỮ LIỆU ---
    function loadHistoryData() {
        fetch('/get_full_history')
            .then(r => r.json())
            .then(data => {
                let html = '';
                if(data.length === 0) {
                    html = '<tr><td colspan="5" style="text-align:center;">Chưa có dữ liệu</td></tr>';
                } else {
                    data.forEach(item => {
                        let badgeClass = item.result === 'OK' ? 'status-ok' : 'status-ng';
                        html += `
                            <tr>
                                <td><img src="/static/history/${item.file}" style="height: 40px; border-radius: 4px; object-fit: cover;" onerror="this.src='https://placehold.co/40?text=IMG'"></td>
                                <td>${item.date}</td>
                                <td>${item.time}</td>
                                <td><span class="status-badge ${badgeClass}">${item.result}</span></td>
                                <td><i class="fa-solid fa-database" style="color:#64748b"></i> Đã lưu</td>
                            </tr>
                        `;
                    });
                }
                document.getElementById('history-table-body').innerHTML = html;
            })
            .catch(err => {
                document.getElementById('history-table-body').innerHTML = '<tr><td colspan="5" style="color:red; text-align:center;">Lỗi kết nối server</td></tr>';
            });
    }

    function loadLogsData() {
        fetch('/get_logs').then(r => r.json()).then(data => {
            let html = '';
            if(data.length === 0) {
                html = '<tr><td colspan="4" style="text-align:center;">Chưa có nhật ký</td></tr>';
            } else {
                data.forEach(item => {
                    html += `<tr>
                        <td>${item.time}</td>
                        <td><b>${item.user}</b></td>
                        <td><span style="color: #3b82f6; font-weight:600">${item.action}</span></td>
                        <td>${item.detail}</td>
                    </tr>`;
                });
            }
            document.getElementById('logs-table-body').innerHTML = html;
        });
    }

    // --- HÀM ĐIỀU KHIỂN ---
    function changeMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.btn-mode').forEach(el => el.classList.remove('active'));
        document.getElementById('btn-mode-' + mode).classList.add('active');
        
        document.getElementById('btn-capture').style.display = (mode === 3) ? 'inline-flex' : 'none';
        
        // Hiện nút phần cứng nếu ở Mode 3
        let hwPanel = document.getElementById('hardware-controls');
        if (hwPanel) hwPanel.style.display = (mode === 3) ? 'block' : 'none';
        
        fetch('/set_mode', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({mode: mode}) 
        });
    }

    function toggleConveyor() {
        conveyorState = !conveyorState;
        let action = conveyorState ? 'on' : 'off';
        
        let btn = document.getElementById('btn-conveyor');
        let lbl = document.getElementById('lbl-conveyor');
        
        if (conveyorState) {
            btn.style.backgroundColor = '#dcfce7'; btn.style.color = '#166534'; lbl.innerText = "ON";
        } else {
            btn.style.backgroundColor = 'white'; btn.style.color = '#64748b'; lbl.innerText = "OFF";
        }

        fetch('/control_hardware', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ device: 'conveyor', action: action })
        });
    }

    function triggerValve() {
        fetch('/control_hardware', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ device: 'valve', action: 'on' })
        });
    }

    function manualCapture() {
        if (isProcessing) return;
        isProcessing = true;
        let btn = document.getElementById('btn-capture');
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang chụp...';
        btn.disabled = true;
        
        fetch('/manual_capture', {method: 'POST'})
            .then(() => {
                // Đặt timeout 5 giây để tránh treo nút
                setTimeout(() => { isProcessing = false; btn.innerHTML = '<i class="fa-solid fa-camera"></i> Chụp Ngay'; btn.disabled = false; }, 5000);
            });
    }

    function uploadAndTestAI() {
        let fileInput = document.getElementById('ai-file-input');
        let file = fileInput.files[0];
        if(!file) return;

        let fd = new FormData(); fd.append('file', file);
        document.getElementById('result-badge').style.display = 'block';
        document.getElementById('result-badge').innerText = "PROCESSING...";
        document.getElementById('result-badge').style.backgroundColor = "#eab308";

        fetch('/test_ai_upload', {method:'POST', body:fd})
            .then(r=>r.json())
            .then(d=>{
                fileInput.value = ''; 
                setTimeout(() => { reloadImage(); }, 500);
            });
    }

    // --- HÀM QUAN TRỌNG: TẢI LẠI ẢNH ĐỂ TRÁNH CACHE ---
    function reloadImage() {
        // Thêm ?t=... là chìa khóa để bắt trình duyệt tải ảnh mới
        let uniqueUrl = "/static/uploads/live.jpg?t=" + new Date().getTime();
        document.getElementById('live-image').src = uniqueUrl;
    }

    function updateUI(stats) {
        if(!stats) return;
        document.getElementById('stat-total').innerText = stats.total || 0;
        document.getElementById('stat-ok').innerText = stats.ok || 0;
        document.getElementById('stat-ng').innerText = stats.ng || 0;
        document.getElementById('stat-ai').innerText = stats.ai_confidence || "---";
        
        chart.data.datasets[0].data = [stats.ok, stats.ng];
        chart.update();

        let badge = document.getElementById('result-badge');
        badge.style.display = 'block';
        badge.innerText = stats.current_result || "WAITING";
        
        if (stats.current_result === 'OK') badge.style.backgroundColor = '#10b981';
        else if (stats.current_result === 'NG') badge.style.backgroundColor = '#ef4444';
        else badge.style.backgroundColor = '#64748b';
    }

    // --- VÒNG LẶP KIỂM TRA DỮ LIỆU MỚI (FIXED) ---
    setInterval(() => {
        if(document.getElementById('section-dashboard').classList.contains('active')) {
            fetch('/check_new_image')
                .then(r => r.json())
                .then(d => {
                    // 1. Cập nhật số liệu
                    if(d.stats) updateUI(d.stats);

                    // 2. LOGIC TỰ ĐỘNG CẬP NHẬT ẢNH KHI CÓ KẾT QUẢ MỚI
                    // Nếu thời gian server > thời gian hiển thị hiện tại -> Tải lại ảnh
                    if (d.last_update > lastDisplayedTime || currentMode === 2) {
                        console.log("Phát hiện ảnh mới! Cập nhật lúc: " + d.last_update);
                        reloadImage();
                        lastDisplayedTime = d.last_update; // Lưu mốc thời gian mới
                        
                        // Nếu đang chụp thủ công -> Reset nút
                        if(isProcessing) {
                            isProcessing = false;
                            let btn = document.getElementById('btn-capture');
                            btn.innerHTML = '<i class="fa-solid fa-camera"></i> Chụp Ngay';
                            btn.disabled = false;
                        }
                    }
                })
                .catch(e => console.log("Polling error:", e));
        }
    }, 1000); // Check mỗi 1 giây

</script>
</body>
</html>